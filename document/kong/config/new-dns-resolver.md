# New DNS Resolver

## 개요

새로운 DNS 리졸버는 워커 간에 DNS 레코드에 대한 전역 캐싱을 도입하여 DNS 서버의 쿼리 부하를 크게 줄입니다.

### 주요 특징

- **전역 캐싱**: 워커 간에 DNS 레코드를 공유하여 효율성을 높입니다
- **관찰 가능한 통계**: Admin API `/status/dns`를 통해 통계를 조회할 수 있습니다
- **향상된 성능**: DNS 서버 쿼리 부하를 크게 줄입니다

## 기본 설정

| 설정                  | 설명                                                                                   | 기본값                                   | 최소 버전 |
| --------------------- | -------------------------------------------------------------------------------------- | ---------------------------------------- | --------- |
| `new_dns_client`      | 새로운 DNS 리졸버를 활성화하거나 비활성화합니다.                                       | `off`                                    | 3.8       |
| `resolver_address`    | Kong에서 사용할 네임서버의 쉼표로 구분된 목록입니다. 각 항목은 `ip[:port]` 형식입니다. | `<name servers parsed from resolv.conf>` | 3.8       |
| `resolver_hosts_file` | 사용할 호스트 파일입니다. 이 파일은 한 번 읽히며 내용은 메모리에서 정적입니다.         | `/etc/hosts`                             | 3.8       |

### resolver_address 형식

- **IPv4 주소**: `8.8.8.8` 또는 `8.8.8.8:53`
- **IPv6 주소**: `[::1]` 또는 `[::1]:53`
- **포트 기본값**: 포트가 생략되면 53이 기본값입니다

**예시**:

- `resolver_address = 8.8.8.8`
- `resolver_address = 8.8.8.8, [::1]`
- `resolver_address = 8.8.8.8:53, [::1]:53`

## DNS 쿼리 설정

| 설정              | 설명                                                                                                                                   | 기본값         | 최소 버전 |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------- | --------- |
| `resolver_family` | 지원되는 쿼리 타입입니다. 도메인 이름에 대해 Kong은 IP 주소(A 또는 AAAA) 또는 SRV 레코드 중 하나만 쿼리하며 둘 다 쿼리하지는 않습니다. | `["A", "SRV"]` | 3.8       |

### DNS 쿼리 동작

- **SRV 레코드**: 도메인이 `_._.` 형식과 일치할 때만 쿼리됩니다 (예: `_ldap._tcp.example.com`)
- **IP 주소 해결**: IPv4(A)를 먼저 시도한 후 IPv6(AAAA)를 쿼리합니다
- **단일 쿼리 타입**: 도메인 이름당 하나의 쿼리 타입만 사용됩니다

## DNS 캐시 설정

| 설정                 | 설명                                                                                                                        | 기본값                 | 최소 버전 |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------- | ---------------------- | --------- |
| `resolver_valid_ttl` | 기본적으로 DNS 레코드는 응답의 TTL 값을 사용하여 캐시됩니다. 이 선택적 매개변수(초)를 통해 이를 덮어쓸 수 있습니다.         | `<TTL from responses>` | 3.8       |
| `resolver_error_ttl` | 오류 응답과 빈 응답에 대한 TTL(초)입니다.                                                                                   | `1`                    | 3.8       |
| `resolver_stale_ttl` | 레코드가 TTL을 지나 캐시에 남아있을 시간(초)을 정의합니다. 새 DNS 레코드가 백그라운드에서 가져오는 동안 이 값이 사용됩니다. | `3600`                 | 3.8       |

### 캐시 동작 설명

- **resolver_valid_ttl**: DNS 응답의 TTL을 덮어쓸 수 있습니다
- **resolver_error_ttl**: 오류 응답의 짧은 TTL(1초)로 빠른 재시도를 가능하게 합니다
- **resolver_stale_ttl**: DNS 서버 다운타임 중 Kong의 복원력을 높입니다

## 캐시 크기 설정

| 설정                      | 설명                                                              | 기본값  | 최소 버전 |
| ------------------------- | ----------------------------------------------------------------- | ------- | --------- |
| `resolver_lru_cache_size` | L1 LRU Lua VM 캐시에 저장된 DNS 응답의 최대 허용 수를 지정합니다. | `10000` | 3.8       |
| `resolver_mem_cache_size` | DNS 응답을 위한 L2 공유 메모리 캐시 크기를 지정합니다.            | `5m`    | 3.8       |

### 2계층 캐시 시스템

새로운 DNS 클라이언트는 2계층 캐시 시스템을 사용합니다:

1. **L1 - 워커 수준 LRU Lua VM 캐시**: `resolver_lru_cache_size`로 제어
2. **L2 - 워커 간 공유 메모리 캐시**: `resolver_mem_cache_size`로 제어

### 캐시 크기 가이드라인

- **단일 A 레코드**: 5MB 공유 메모리로 ~20,000개 DNS 응답 저장 가능
- **2-3개 A 레코드**: 5MB 공유 메모리로 ~10,000개 DNS 응답 저장 가능
- **단일 A 레코드**: 10MB 공유 메모리로 ~40,000개 DNS 응답 저장 가능
- **2-3개 A 레코드**: 10MB 공유 메모리로 ~20,000개 DNS 응답 저장 가능

**참고**: 단일 이름 쿼리는 시도된 쿼리 타입과 `/etc/resolv.conf` 옵션의 도메인 또는 검색에서 확장된 도메인에 따라 쉽게 1~10개의 슬롯을 차지할 수 있습니다.

## 성능 최적화

### 캐시 효율성

- **L1 캐시**: 워커별 빠른 액세스를 위한 LRU 캐시
- **L2 캐시**: 워커 간 공유를 통한 메모리 효율성
- **Stale TTL**: DNS 서버 다운타임 중 서비스 연속성 보장

### 메모리 사용량

- **resolver_lru_cache_size**: 워커별 메모리 사용량 제어
- **resolver_mem_cache_size**: 전체 공유 메모리 사용량 제어
- **단위**: k(킬로바이트) 또는 m(메가바이트) 사용 가능

### 운영 권장사항

- **최소 메모리**: 몇 MB의 최소 권장 값
- **모니터링**: Admin API `/status/dns`를 통한 통계 모니터링
- **캐시 크기 조정**: 예상되는 DNS 조회 볼륨에 따라 적절히 조정

## 기존 DNS 리졸버와의 차이점

### 개선사항

- **전역 캐싱**: 워커 간 DNS 레코드 공유
- **2계층 캐시**: L1(워커별) + L2(공유) 캐시 시스템
- **관찰 가능성**: DNS 통계 API 제공
- **성능 향상**: DNS 서버 부하 감소

### 마이그레이션 고려사항

- **호환성**: 기존 DNS 설정과 호환
- **점진적 적용**: `new_dns_client` 설정으로 활성화
- **성능 테스트**: 프로덕션 적용 전 충분한 테스트 권장
