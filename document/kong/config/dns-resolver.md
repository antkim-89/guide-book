# DNS Resolver

## 개요

Kong의 DNS 리졸버는 기본적으로 표준 구성 파일인 `/etc/hosts`와 `/etc/resolv.conf`를 사용합니다. 후자의 파일에 있는 설정은 `LOCALDOMAIN`과 `RES_OPTIONS` 환경 변수가 설정되어 있으면 덮어쓰여집니다.

### DNS 해결 동작

- **레코드 타입**: Kong은 호스트명을 SRV 또는 A 레코드로 해결합니다 (이 순서대로, CNAME 레코드는 프로세스에서 역참조됩니다).
- **SRV 레코드**: 이름이 SRV 레코드로 해결되면 주어진 포트 번호를 DNS 서버에서 받은 포트 필드 내용으로 덮어씁니다.
- **SEARCH 및 NDOTS**: `/etc/resolv.conf` 파일의 DNS 옵션 SEARCH와 NDOTS가 짧은 이름을 완전한 이름으로 확장하는 데 사용됩니다.
- **로드 밸런싱**: TTL 기간 동안 내부 DNS 리졸버는 받은 각 요청을 DNS 레코드의 항목에 대해 로드 밸런싱합니다.
- **SRV 레코드 가중치**: SRV 레코드의 경우 가중치 필드가 존중되지만 레코드의 가장 낮은 우선순위 필드 항목만 사용합니다.

### TTL 0 레코드 처리

TTL 값이 0인 DNS 레코드의 경우, Kong은 기본적으로 이러한 레코드를 1초 동안 캐시합니다. TTL 0 레코드를 캐시하지 않는다는 요구사항을 엄격히 준수하면 업스트림 DNS 서버에 대한 과도한 쿼리 빈도가 발생하여 지속 불가능한 부하와 잠재적인 서비스 저하를 초래할 수 있습니다.

## DNS 리졸버 설정

| 설정            | 설명                                                                                                                                                  | 기본값                          |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------- |
| `dns_resolver`  | Kong에서 사용할 네임서버의 쉼표로 구분된 목록입니다. 각 항목은 `ip[:port]` 형식입니다. 지정하지 않으면 로컬 resolv.conf 파일의 네임서버가 사용됩니다. | -                               |
| `dns_hostsfile` | 사용할 호스트 파일입니다. 이 파일은 한 번 읽히며 내용은 메모리에서 정적입니다. 수정 후 파일을 다시 읽으려면 Kong을 다시 로드해야 합니다.              | `/etc/hosts`                    |
| `dns_order`     | 다른 레코드 타입을 해결하는 순서입니다. LAST 타입은 마지막 성공적인 조회의 타입을 의미합니다.                                                         | `["LAST", "SRV", "A", "CNAME"]` |

### dns_resolver 형식

- **IPv4 주소**: `192.168.1.1` 또는 `192.168.1.1:53`
- **IPv6 주소**: `[2001:db8::1]` 또는 `[2001:db8::1]:53`
- **포트 기본값**: 포트가 생략되면 53이 기본값입니다.

## DNS 캐시 설정

| 설정                | 설명                                                                                                                                      | 기본값  |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| `dns_valid_ttl`     | 기본적으로 DNS 레코드는 응답의 TTL 값을 사용하여 캐시됩니다. 이 속성이 값(초)을 받으면 모든 레코드의 TTL을 덮어씁니다.                    | -       |
| `dns_stale_ttl`     | 레코드가 TTL을 지나 캐시에 남아있을 시간(초)을 정의합니다. 새 DNS 레코드가 백그라운드에서 가져오는 동안 이 값이 사용됩니다.               | `3600`  |
| `dns_cache_size`    | 메모리 캐시에 저장된 DNS 레코드의 최대 허용 수를 정의합니다. 캐시가 가득 차면 가장 최근에 사용되지 않은 DNS 레코드가 캐시에서 제거됩니다. | `10000` |
| `dns_not_found_ttl` | 빈 DNS 응답과 "(3) name error" 응답에 대한 TTL(초)입니다.                                                                                 | `30`    |
| `dns_error_ttl`     | 오류 응답에 대한 TTL(초)입니다.                                                                                                           | `1`     |

### 캐시 동작 설명

- **dns_stale_ttl**: 레코드 만료부터 새로 고침 쿼리가 완료되거나 `dns_stale_ttl` 초가 지날 때까지 오래된 데이터가 사용됩니다.
- **dns_cache_size**: 오류와 데이터 모두 캐시되므로 단일 이름 쿼리가 쉽게 10-15개의 슬롯을 차지할 수 있습니다.
- **dns_not_found_ttl**: DNS 조회에서 "이름을 찾을 수 없음" 응답을 받았을 때의 캐시 시간입니다.
- **dns_error_ttl**: DNS 조회에서 오류 응답을 받았을 때의 캐시 시간입니다.

## DNS 동기화 설정

| 설정          | 설명                                                                                                                                         | 기본값 |
| ------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| `dns_no_sync` | 활성화되면 캐시 미스 시 모든 요청이 자체 DNS 쿼리를 트리거합니다. 비활성화되면 동일한 이름/타입에 대한 여러 요청이 단일 쿼리로 동기화됩니다. | `off`  |

### 동기화 동작

- **dns_no_sync = off (기본값)**: 동일한 이름/타입에 대한 여러 요청이 단일 DNS 쿼리로 동기화되어 효율성을 높입니다.
- **dns_no_sync = on**: 각 요청이 독립적으로 DNS 쿼리를 수행하여 더 빠른 응답을 제공할 수 있지만 DNS 서버에 더 많은 부하를 줄 수 있습니다.

## DNS 해결 순서

`dns_order` 설정에 따라 Kong은 다음 순서로 DNS 레코드를 해결합니다:

1. **LAST**: 마지막 성공적인 조회의 타입
2. **SRV**: 서비스 레코드 (포트 정보 포함)
3. **A**: IPv4 주소 레코드
4. **CNAME**: 별칭 레코드 (역참조됨)

### DNS 해결 프로세스

1. **SEARCH 목록 사용**: 짧은 이름을 완전한 이름으로 확장하기 위해 `/etc/resolv.conf`의 SEARCH 목록을 사용합니다.
2. **SRV 우선**: SRV 타입에 대해 전체 SEARCH 목록을 먼저 시도합니다.
3. **A 레코드 시도**: SRV가 실패하면 A 레코드에 대해 SEARCH 목록을 시도합니다.
4. **가중치 처리**: SRV 레코드의 경우 가중치 필드를 존중하지만 가장 낮은 우선순위 필드 항목만 사용합니다.

## 성능 고려사항

### 캐시 효율성

- **dns_cache_size**: 메모리 사용량과 캐시 히트율 사이의 균형을 조정합니다.
- **dns_stale_ttl**: 리졸버 다운타임 중 Kong의 복원력을 높입니다.
- **dns_valid_ttl**: 모든 레코드에 대해 일관된 TTL을 적용할 수 있습니다.

### 네트워크 최적화

- **dns_no_sync**: 동기화를 비활성화하면 개별 요청이 더 빠르게 처리될 수 있지만 DNS 서버 부하가 증가할 수 있습니다.
- **dns_error_ttl**: 오류 응답의 짧은 TTL(1초)로 빠른 재시도를 가능하게 합니다.

### 운영 권장사항

- **dns_stale_ttl**: 리졸버 다운타임에 대한 복원력을 위해 충분한 값을 설정하세요.
- **dns_cache_size**: 예상되는 DNS 조회 볼륨에 따라 적절히 조정하세요.
- **dns_resolver**: 신뢰할 수 있는 DNS 서버를 지정하여 안정성을 확보하세요.
