# Route Collision Detection/Prevention

## 개요

Route Collision Detection/Prevention은 라우트를 생성하거나 업데이트할 때 라우트 충돌을 감지하고 방지하는 메커니즘입니다. 워크스페이스 간 트래픽 분할을 강제하는 방법을 조정하기 위해 다양한 전략을 사용할 수 있습니다.

### 주요 특징

- **충돌 감지**: 워크스페이스 간 라우트 충돌을 자동으로 감지합니다
- **다양한 전략**: smart, off, path, static 등 다양한 검증 전략을 제공합니다
- **패턴 강제**: 라우트 경로가 특정 패턴을 준수하도록 강제할 수 있습니다
- **데이터베이스 검증**: PostgreSQL을 사용한 정적 검증을 지원합니다

## Route Validation Strategy 설정

| 설정                        | 설명                                                                                                                                                     | 기본값  |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| `route_validation_strategy` | 라우트를 생성하거나 업데이트할 때 사용되는 검증 전략입니다. 워크스페이스의 트래픽 분할을 강제하는 방법을 조정하기 위해 다양한 전략을 사용할 수 있습니다. | `smart` |

### route_validation_strategy 유효한 값

| 전략     | 설명                                                                                                                                                                |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `smart`  | 기본 옵션으로 https://docs.konghq.com/gateway/latest/kong-enterprise/workspaces/에 설명된 알고리즘을 사용합니다.                                                    |
| `off`    | 모든 검사를 비활성화합니다.                                                                                                                                         |
| `path`   | 라우트가 `enforce_route_path_pattern` 구성에 설명된 패턴을 준수하도록 강제합니다.                                                                                   |
| `static` | PostgreSQL 데이터베이스를 사용합니다. 새 라우트를 생성하기 전에 다음 매개변수(paths, methods, hosts)를 기반으로 모든 워크스페이스에서 라우트가 고유한지 확인합니다. |

### smart 전략

- **알고리즘 기반**: Kong Enterprise 워크스페이스 문서에 설명된 알고리즘을 사용합니다
- **자동 최적화**: 워크스페이스 간 트래픽 분할을 자동으로 최적화합니다
- **권장 설정**: 대부분의 경우에 권장되는 기본 설정입니다

### off 전략

- **검사 비활성화**: 모든 라우트 충돌 검사를 비활성화합니다
- **성능 향상**: 검사 오버헤드가 없어 성능이 향상됩니다
- **주의 필요**: 충돌이 발생할 수 있으므로 신중하게 사용해야 합니다

### path 전략

- **패턴 강제**: 라우트가 지정된 패턴을 준수하도록 강제합니다
- **워크스페이스 지원**: 패턴에 워크스페이스 플레이스홀더를 포함할 수 있습니다
- **런타임 렌더링**: 워크스페이스에 따라 패턴이 런타임에 렌더링됩니다

### static 전략

- **데이터베이스 검증**: PostgreSQL 데이터베이스를 사용하여 검증합니다
- **고유성 확인**: paths, methods, hosts 매개변수를 기반으로 고유성을 확인합니다
- **충돌 응답**: 충돌이 발견되면 409 상태 코드와 함께 충돌하는 라우트를 반환합니다
- **배열 순서 무관**: 겹침 필터에서 배열 순서는 중요하지 않습니다

## Route Path Pattern Enforcement 설정

| 설정                         | 설명                                                                                                                                                                                     | 기본값 |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| `enforce_route_path_pattern` | 라우트 객체의 paths 속성에 적용될 Lua 패턴을 지정합니다. 워크스페이스에 대한 플레이스홀더를 패턴에 추가할 수도 있으며, 이는 라우트가 속한 워크스페이스를 기반으로 런타임에 렌더링됩니다. | -      |

### 패턴 설정 규칙

| 규칙                          | 설명                                                                      |
| ----------------------------- | ------------------------------------------------------------------------- |
| **워크스페이스 플레이스홀더** | `$(workspace)`를 사용하여 워크스페이스 이름을 동적으로 삽입할 수 있습니다 |
| **Lua 패턴 문법**             | 표준 Lua 패턴 문법을 사용합니다                                           |
| **런타임 렌더링**             | 패턴이 런타임에 워크스페이스에 따라 렌더링됩니다                          |
| **path 전략 전용**            | `route_validation_strategy`가 `path`로 설정된 경우에만 관련이 있습니다    |

### 패턴 예시

#### 기본 패턴

```
/$(workspace)/v%d/.*
```

#### 유효한 경로 예시

| 워크스페이스 | 유효한 경로            | 설명                                |
| ------------ | ---------------------- | ----------------------------------- |
| `group1`     | `/group1/v1/`          | group1 워크스페이스에 속하는 라우트 |
| `group2`     | `/group2/v1/some_path` | group2 워크스페이스에 속하는 라우트 |
| `team-a`     | `/team-a/v2/api`       | team-a 워크스페이스에 속하는 라우트 |

#### 패턴 구성 요소 설명

| 구성 요소      | 설명                           | 예시               |
| -------------- | ------------------------------ | ------------------ |
| `$(workspace)` | 워크스페이스 이름 플레이스홀더 | `group1`, `team-a` |
| `v%d`          | 버전 번호 (숫자)               | `v1`, `v2`, `v3`   |
| `.*`           | 모든 문자 (Lua 패턴)           | `api`, `some_path` |

## 충돌 감지 제한사항

### 지원되는 라우트 유형

| 라우트 유형            | 지원 여부    | 설명                                               |
| ---------------------- | ------------ | -------------------------------------------------- |
| **일반 텍스트 라우트** | ✅ 지원      | 충돌 감지가 완전히 지원됩니다                      |
| **정규식 라우트**      | ❌ 지원 안함 | 이 기능에 의존하여 정규식 라우트를 검증하지 마세요 |

### 주의사항

- **정규식 제외**: 충돌 감지는 일반 텍스트 라우트에만 지원됩니다
- **신뢰성**: 정규식 라우트의 경우 다른 검증 방법을 사용해야 합니다
- **성능**: 정규식 라우트는 성능에 영향을 줄 수 있습니다

## 사용 시나리오

### 1. 워크스페이스 격리

```yaml
route_validation_strategy: path
enforce_route_path_pattern: /$(workspace)/api/.*
```

**결과**: 각 워크스페이스는 `/workspace-name/api/` 접두사로 시작하는 라우트만 가질 수 있습니다.

### 2. 버전별 라우트 관리

```yaml
route_validation_strategy: path
enforce_route_path_pattern: /$(workspace)/v%d/.*
```

**결과**: 각 워크스페이스는 `/workspace-name/v숫자/` 형식의 라우트만 가질 수 있습니다.

### 3. 정적 검증

```yaml
route_validation_strategy: static
```

**결과**: 데이터베이스에서 paths, methods, hosts를 기반으로 고유성을 검증합니다.

### 4. 검증 비활성화

```yaml
route_validation_strategy: off
```

**결과**: 모든 충돌 검사가 비활성화됩니다.

## 오류 처리

### 충돌 감지 시 응답

| 상황                  | HTTP 상태 코드              | 응답 내용                        |
| --------------------- | --------------------------- | -------------------------------- |
| **라우트 충돌 발견**  | `409 Conflict`              | 충돌하는 라우트 정보와 함께 반환 |
| **패턴 위반**         | `400 Bad Request`           | 패턴 위반 오류 메시지            |
| **데이터베이스 오류** | `500 Internal Server Error` | 데이터베이스 연결 또는 쿼리 오류 |

### 오류 메시지 예시

```json
{
  "message": "Route collision detected",
  "collision": {
    "workspace": "group1",
    "route_id": "12345",
    "paths": ["/api/users"],
    "methods": ["GET"],
    "hosts": ["example.com"]
  }
}
```

## 성능 고려사항

### 전략별 성능 특성

| 전략     | 성능 | 설명                                  |
| -------- | ---- | ------------------------------------- |
| `off`    | 최고 | 검사 오버헤드가 없습니다              |
| `smart`  | 높음 | 최적화된 알고리즘을 사용합니다        |
| `path`   | 중간 | 패턴 매칭 오버헤드가 있습니다         |
| `static` | 낮음 | 데이터베이스 쿼리 오버헤드가 있습니다 |

### 최적화 권장사항

- **적절한 전략 선택**: 사용 사례에 맞는 전략을 선택하세요
- **패턴 최적화**: 복잡한 패턴은 성능에 영향을 줄 수 있습니다
- **데이터베이스 인덱스**: static 전략 사용 시 적절한 인덱스를 설정하세요

## 보안 고려사항

### 워크스페이스 격리

- **접근 제어**: 워크스페이스 간 라우트 접근을 제어하세요
- **패턴 검증**: 악의적인 패턴을 방지하세요
- **권한 관리**: 라우트 생성 권한을 적절히 관리하세요

### 데이터 무결성

- **충돌 방지**: 라우트 충돌로 인한 서비스 중단을 방지하세요
- **검증 강화**: 적절한 검증 전략을 사용하세요
- **모니터링**: 라우트 충돌을 모니터링하세요

## 운영 권장사항

### 전략 선택 가이드

| 사용 사례             | 권장 전략 | 이유                             |
| --------------------- | --------- | -------------------------------- |
| **개발 환경**         | `off`     | 빠른 개발을 위해 검사를 비활성화 |
| **프로덕션 환경**     | `smart`   | 자동 최적화와 충돌 방지          |
| **엄격한 격리**       | `path`    | 워크스페이스별 패턴 강제         |
| **데이터베이스 중심** | `static`  | 데이터베이스 기반 정확한 검증    |

### 모니터링

- **충돌 로그**: 라우트 충돌을 모니터링하세요
- **성능 메트릭**: 검증 전략의 성능 영향을 모니터링하세요
- **오류 추적**: 검증 관련 오류를 추적하세요

### 유지보수

- **패턴 업데이트**: 필요에 따라 라우트 패턴을 업데이트하세요
- **전략 조정**: 사용 패턴에 따라 검증 전략을 조정하세요
- **문서화**: 라우트 정책을 문서화하세요
