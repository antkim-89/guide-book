# Datastore Configuration

## 개요

Kong은 클러스터의 Kong 노드 간에 조정된 데이터를 저장하기 위해 데이터베이스와 함께 실행하거나, 데이터베이스 없이 각 노드가 메모리에 정보를 독립적으로 저장할 수 있습니다.

### 데이터베이스 모드

- **PostgreSQL 사용**: Kong은 모든 엔티티(라우트, 서비스, 소비자, 플러그인 등)의 데이터를 PostgreSQL에 저장합니다.
- **지원 버전**: PostgreSQL 9.5 이상
- **클러스터 요구사항**: 동일한 클러스터에 속한 모든 Kong 노드는 동일한 데이터베이스에 연결해야 합니다.

### DB-less 모드

- **메모리 저장**: 엔티티를 메모리에 보관합니다.
- **설정 방법**:
  - `declarative_config` 속성을 통한 선언적 구성 파일
  - Admin API의 `/config` 엔드포인트 사용

### 읽기 전용 PostgreSQL 인스턴스

- **선택적 기능**: 읽기 쿼리를 별도의 데이터베이스 인스턴스에서 제공할 수 있습니다.
- **장점**: 프록시 수가 많을 때 메인 Postgres 인스턴스의 부하를 크게 줄이고 더 나은 확장성을 달성할 수 있습니다.
- **설정**: 최소한 `pg_ro_host` 설정이 필요합니다.

## 기본 데이터베이스 설정

| 설정          | 설명                                                                                                        | 기본값      |
| ------------- | ----------------------------------------------------------------------------------------------------------- | ----------- |
| `database`    | 이 노드의 데이터베이스(또는 데이터베이스 없음)를 결정합니다.                                                | `postgres`  |
| `pg_host`     | Postgres 서버의 호스트입니다.                                                                               | `127.0.0.1` |
| `pg_port`     | Postgres 서버의 포트입니다.                                                                                 | `5432`      |
| `pg_timeout`  | 연결, 읽기, 쓰기에 대한 타임아웃(밀리초)을 정의합니다.                                                      | `5000`      |
| `pg_user`     | Postgres 사용자입니다.                                                                                      | `kong`      |
| `pg_password` | Postgres 사용자의 비밀번호입니다.                                                                           | -           |
| `pg_database` | 연결할 데이터베이스 이름입니다.                                                                             | `kong`      |
| `pg_schema`   | 사용할 데이터베이스 스키마입니다. 지정하지 않으면 Kong이 PostgreSQL 인스턴스의 search_path 값을 존중합니다. | -           |

### database 유효한 값

- `postgres`: PostgreSQL 데이터베이스 사용
- `off`: 데이터베이스 없이 실행 (DB-less 모드)

## AWS IAM 인증 설정

| 설정                            | 설명                                                                                     | 기본값         |
| ------------------------------- | ---------------------------------------------------------------------------------------- | -------------- |
| `pg_iam_auth`                   | AWS IAM 데이터베이스 인증을 사용할지 결정합니다.                                         | `off`          |
| `pg_iam_auth_assume_role_arn`   | AWS IAM 데이터베이스 인증 사용 시 가정할 대상 AWS IAM 역할 ARN입니다.                    | -              |
| `pg_iam_auth_role_session_name` | AWS IAM 데이터베이스 인증에서 역할 가정에 사용되는 역할 세션 이름입니다.                 | `KongPostgres` |
| `pg_iam_auth_sts_endpoint_url`  | AWS IAM 데이터베이스 인증에서 역할 가정에 사용되는 사용자 정의 STS 엔드포인트 URL입니다. | -              |

**중요 참고사항**:

- `pg_iam_auth`가 켜져 있으면 `pg_user`에 정의된 사용자명이 데이터베이스 계정으로 사용됩니다.
- 데이터베이스 연결이 TLS를 사용하도록 강제됩니다.
- `pg_password`는 스위치가 켜져 있을 때 사용되지 않습니다.
- 해당 IAM 정책이 올바르야 하며, 그렇지 않으면 연결이 실패합니다.

## SSL/TLS 설정

| 설정              | 설명                                                                                                      | 기본값    |
| ----------------- | --------------------------------------------------------------------------------------------------------- | --------- |
| `pg_ssl`          | Kong과 PostgreSQL 간의 클라이언트-서버 TLS 연결을 토글합니다.                                             | `off`     |
| `pg_ssl_version`  | Kong과 PostgreSQL 간에 SSL을 사용할 때 사용할 TLS 버전입니다.                                             | `tlsv1_2` |
| `pg_ssl_required` | `pg_ssl`이 켜져 있을 때 Kong과 PostgreSQL 간에 TLS를 사용해야 하는지 결정합니다.                          | `off`     |
| `pg_ssl_verify`   | `pg_ssl`이 활성화된 경우 서버 인증서 검증을 토글합니다.                                                   | `off`     |
| `pg_ssl_cert`     | PostgreSQL 연결을 위한 PEM 인코딩된 클라이언트 TLS 인증서의 절대 경로입니다.                              | -         |
| `pg_ssl_cert_key` | `pg_ssl_cert`가 설정된 경우 PostgreSQL 연결을 위한 PEM 인코딩된 클라이언트 TLS 개인 키의 절대 경로입니다. | -         |

### pg_ssl_version 유효한 값

- `tlsv1_1`: TLS 1.1
- `tlsv1_2`: TLS 1.2
- `tlsv1_3`: TLS 1.3
- `any`: 서버와 협상 가능한 최고 버전 (tlsv1_1 이상)

## 연결 풀 및 동시성 설정

| 설정                        | 설명                                                                                          | 기본값  |
| --------------------------- | --------------------------------------------------------------------------------------------- | ------- |
| `pg_max_concurrent_queries` | 언제든지 실행할 수 있는 최대 동시 쿼리 수를 설정합니다. 이 제한은 워커 프로세스당 적용됩니다. | `0`     |
| `pg_semaphore_timeout`      | PostgreSQL 쿼리 세마포어 리소스 획득 시도가 실패할 타임아웃(밀리초)을 정의합니다.             | `60000` |
| `pg_keepalive_timeout`      | 풀의 postgres 연결에 대한 최대 유휴 타임아웃(밀리초)을 지정합니다.                            | -       |
| `pg_pool_size`              | Postgres 서버의 크기 제한(연결 수 기준)을 지정합니다.                                         | -       |
| `pg_backlog`                | 지정된 경우 이 값은 Postgres 서버에 대한 열린 연결의 총 수를 `pg_pool_size`로 제한합니다.     | -       |

**참고**:

- `pg_max_concurrent_queries`의 기본값 0은 이 동시성 제한을 제거합니다.
- 이 노드의 총 동시 쿼리 수는 `pg_max_concurrent_queries * nginx_worker_processes`가 됩니다.
- `pg_keepalive_timeout`이 지정되지 않으면 `lua_socket_keepalive_timeout`과 동일한 값이 사용됩니다.
- `pg_pool_size`가 지정되지 않으면 기본값은 `lua_socket_pool_size`와 동일합니다.

## 읽기 전용 연결 설정

| 설정             | 설명                                                           | 기본값          |
| ---------------- | -------------------------------------------------------------- | --------------- |
| `pg_ro_host`     | 읽기 전용 연결을 위한 Postgres 서버 호스트입니다.              | -               |
| `pg_ro_port`     | 읽기 전용 연결을 위한 Postgres 서버 포트입니다.                | `<pg_port>`     |
| `pg_ro_timeout`  | 읽기 전용 연결을 위한 연결, 읽기, 쓰기 타임아웃(밀리초)입니다. | `<pg_timeout>`  |
| `pg_ro_user`     | 읽기 전용 연결을 위한 Postgres 사용자입니다.                   | `<pg_user>`     |
| `pg_ro_password` | 읽기 전용 연결을 위한 Postgres 사용자 비밀번호입니다.          | `<pg_password>` |
| `pg_ro_database` | 읽기 전용 연결을 위한 데이터베이스 이름입니다.                 | `<pg_database>` |
| `pg_ro_schema`   | 읽기 전용 연결을 위한 데이터베이스 스키마입니다.               | `<pg_schema>`   |

### 읽기 전용 AWS IAM 설정

| 설정                               | 설명                                                        | 기본값          |
| ---------------------------------- | ----------------------------------------------------------- | --------------- |
| `pg_ro_iam_auth`                   | 읽기 전용 연결을 위한 AWS IAM 데이터베이스 인증 설정입니다. | `<pg_iam_auth>` |
| `pg_ro_iam_auth_assume_role_arn`   | 읽기 전용 연결을 위한 AWS IAM 역할 ARN입니다.               | -               |
| `pg_ro_iam_auth_role_session_name` | 읽기 전용 연결을 위한 역할 세션 이름입니다.                 | `KongPostgres`  |
| `pg_ro_iam_auth_sts_endpoint_url`  | 읽기 전용 연결을 위한 STS 엔드포인트 URL입니다.             | -               |

### 읽기 전용 SSL/TLS 설정

| 설정                 | 설명                                       | 기본값              |
| -------------------- | ------------------------------------------ | ------------------- |
| `pg_ro_ssl`          | 읽기 전용 연결을 위한 SSL 설정입니다.      | `<pg_ssl>`          |
| `pg_ro_ssl_version`  | 읽기 전용 연결을 위한 SSL 버전입니다.      | `<pg_ssl_version>`  |
| `pg_ro_ssl_required` | 읽기 전용 연결을 위한 SSL 필수 설정입니다. | `<pg_ssl_required>` |
| `pg_ro_ssl_verify`   | 읽기 전용 연결을 위한 SSL 검증 설정입니다. | `<pg_ssl_verify>`   |

### 읽기 전용 연결 풀 설정

| 설정                           | 설명                                            | 기본값                        |
| ------------------------------ | ----------------------------------------------- | ----------------------------- |
| `pg_ro_max_concurrent_queries` | 읽기 전용 연결을 위한 최대 동시 쿼리 수입니다.  | `<pg_max_concurrent_queries>` |
| `pg_ro_semaphore_timeout`      | 읽기 전용 연결을 위한 세마포어 타임아웃입니다.  | `<pg_semaphore_timeout>`      |
| `pg_ro_keepalive_timeout`      | 읽기 전용 연결을 위한 keepalive 타임아웃입니다. | `<pg_keepalive_timeout>`      |
| `pg_ro_pool_size`              | 읽기 전용 연결을 위한 풀 크기입니다.            | `<pg_pool_size>`              |
| `pg_ro_backlog`                | 읽기 전용 연결을 위한 백로그 설정입니다.        | `<pg_backlog>`                |

**참고**: 읽기 전용 동시성은 메인(읽기-쓰기) 연결과 공유되지 않습니다.

## DB-less 모드 설정

| 설정                        | 설명                                                                                                                          | 기본값        |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------------- |
| `declarative_config`        | 데이터베이스가 off로 설정될 때 사용할 모든 엔티티(라우트, 서비스, 소비자 등)의 사양을 보유하는 선언적 구성 파일의 경로입니다. | -             |
| `declarative_config_string` | 문자열로 된 선언적 구성입니다.                                                                                                | -             |
| `lmdb_environment_path`     | DB-less 및 하이브리드 모드에서 Kong 구성을 저장하는 데 사용되는 LMDB 데이터베이스 파일이 있는 디렉토리입니다.                 | `dbless.lmdb` |
| `lmdb_map_size`             | DB-less 및 하이브리드 모드 구성을 저장하는 데 사용되는 LMDB 메모리 맵의 최대 크기입니다.                                      | `2048m`       |

**중요 참고사항**:

- 엔티티는 Kong의 LMDB 캐시에 저장되므로 `lmdb_map_size` 속성을 통해 충분한 여유 공간이 할당되어야 합니다.
- 하이브리드 모드 역할이 `data_plane`으로 설정되고 구성 캐시 파일이 없는 경우, 이 구성은 제어 평면 노드에 연결하기 전에 사용자 제어 폴백으로 사용됩니다.

## 데이터베이스 캐시 설정

| 설정                       | 설명                                                                                                                     | 기본값     |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ---------- |
| `db_update_frequency`      | 데이터스토어에서 업데이트된 엔티티를 확인하는 빈도(초)입니다.                                                            | `5`        |
| `db_update_propagation`    | 데이터스토어의 엔티티가 다른 데이터센터의 복제본 노드에 전파되는 데 걸리는 시간(초)입니다.                               | `0`        |
| `db_cache_ttl`             | 이 노드에서 캐시될 때 데이터스토어의 엔티티의 TTL(초)입니다.                                                             | `0`        |
| `db_cache_neg_ttl`         | 데이터스토어 미스(엔티티 없음)의 TTL(초)입니다.                                                                          | -          |
| `db_resurrect_ttl`         | 데이터스토어에서 오래된 엔티티를 새로 고칠 수 없을 때(예: 데이터스토어에 도달할 수 없음) 부활시켜야 하는 시간(초)입니다. | `30`       |
| `db_cache_warmup_entities` | Kong 시작 시 데이터스토어에서 메모리 내 캐시로 미리 로드할 엔티티입니다.                                                 | `services` |

### 캐시 동작 설명

- **db_update_frequency**: 노드가 Admin API를 통해 엔티티를 생성, 업데이트 또는 삭제할 때 다른 노드는 다음 폴링(이 값으로 구성)을 기다려야 오래된 캐시된 엔티티를 제거하고 새로운 엔티티를 사용하기 시작합니다.
- **db_update_propagation**: 단일 데이터센터 설정이나 PostgreSQL 서버는 이러한 지연을 겪지 않아야 하며 이 값을 안전하게 0으로 설정할 수 있습니다.
- **db_cache_ttl**: 0(기본값)으로 설정하면 이러한 캐시된 엔티티나 미스가 만료되지 않습니다.
- **db_cache_neg_ttl**: 지정되지 않으면(기본값) `db_cache_ttl` 값이 대신 사용됩니다.
- **db_resurrect_ttl**: 이 TTL이 만료되면 오래된 엔티티를 새로 고치려는 새로운 시도가 이루어집니다.

### 캐시 워밍업

- **db_cache_warmup_entities**: 지정된 엔티티를 사용하는 엔드포인트의 첫 번째 액세스를 가속화합니다.
- **서비스 엔티티**: 서비스 엔티티가 워밍업을 위해 구성되면 해당 호스트 속성의 값에 대한 DNS 항목도 비동기적으로 미리 해결됩니다.
- **메모리 요구사항**: `mem_cache_size`에 설정된 캐시 크기는 지정된 엔티티의 모든 인스턴스를 보유할 수 있을 만큼 충분히 큰 값으로 설정되어야 합니다. 크기가 부족하면 Kong이 경고를 기록합니다.
