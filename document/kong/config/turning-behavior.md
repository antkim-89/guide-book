# Tuning & Behavior

## 개요

Tuning & Behavior 설정은 Kong의 성능과 동작을 조정하는 다양한 설정을 포함합니다. 워커 일관성, 라우터 구현, Lua 제한, Vault 지연 로딩 등의 설정을 통해 Kong의 성능을 최적화할 수 있습니다.

### 주요 특징

- **워커 일관성**: 동기/비동기 상태 재구성 제어
- **라우터 최적화**: 다양한 라우터 구현 선택
- **Lua 제한**: 메모리 사용량과 성능 최적화
- **Vault 최적화**: 지연 로딩을 통한 시작 성능 향상

## 워커 일관성 설정

| 설정                 | 설명                                                                                                                                                                   | 기본값     |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| `worker_consistency` | 이 노드가 상태를 동기적으로 또는 비동기적으로 재구성할지 정의합니다. (이 옵션은 deprecated되었으며 향후 릴리스에서 제거될 예정입니다. 새로운 기본값은 eventual입니다.) | `eventual` |

### worker_consistency 유효한 값

| 값         | 설명                                                                                                                                                | 상태       |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| `strict`   | 라우터가 동기적으로 재구성되어 들어오는 요청이 재구성이 완료될 때까지 지연됩니다. (이 옵션은 deprecated되었으며 향후 릴리스에서 제거될 예정입니다.) | Deprecated |
| `eventual` | 라우터가 각 워커 내에서 매초 실행되는 반복 백그라운드 작업을 통해 비동기적으로 재구성됩니다.                                                        | 권장       |

### 워커 일관성 비교

| 측면          | strict                                                           | eventual                                          |
| ------------- | ---------------------------------------------------------------- | ------------------------------------------------- |
| **일관성**    | 모든 워커가 항상 동일한 라우터로 요청을 프록시합니다             | 짧은 기간 동안 워커가 다르게 라우팅할 수 있습니다 |
| **지연 시간** | 라우트/서비스 업데이트 시 긴 꼬리 지연 시간이 발생할 수 있습니다 | 긴 꼬리 지연 시간 문제를 방지합니다               |
| **성능**      | 동기 재구성으로 인한 성능 저하                                   | 비동기 재구성으로 성능 향상                       |
| **사용 권장** | ❌ Deprecated                                                    | ✅ 권장                                           |

## 워커 상태 업데이트 설정

| 설정                            | 설명                                                                                                                            | 기본값 |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- | ------ |
| `worker_state_update_frequency` | 백그라운드 작업이 워커 상태 변경을 확인하는 빈도를 정의합니다. 변경이 감지되면 필요에 따라 새로운 라우터나 밸런서가 구축됩니다. | `5`    |

### 업데이트 빈도 영향

| 설정값             | 영향                                         | 권장 사용          |
| ------------------ | -------------------------------------------- | ------------------ |
| **낮은 값 (1-3)**  | 더 빠른 변경 전파, 더 높은 데이터베이스 부하 | 자주 변경되는 환경 |
| **중간 값 (4-7)**  | 균형잡힌 성능과 전파 속도                    | 일반적인 환경      |
| **높은 값 (8-15)** | 낮은 데이터베이스 부하, 느린 변경 전파       | 안정적인 환경      |

## 라우터 구현 설정

| 설정            | 설명                                                     | 기본값                   |
| --------------- | -------------------------------------------------------- | ------------------------ |
| `router_flavor` | 요청 라우팅을 수행할 때 사용할 라우터 구현을 선택합니다. | `traditional_compatible` |

### router_flavor 유효한 값

| 값                       | 설명                                                                                                                                                                                        | 상태          | 특징                    |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- | ----------------------- |
| `traditional_compatible` | DSL 기반 표현식 라우터 엔진이 내부적으로 사용됩니다. 하지만 라우터 구성 인터페이스는 기존과 동일하며, 표현식은 라우터 구축 시 자동으로 생성됩니다.                                          | ✅ 권장       | 기존 호환성 + 성능 향상 |
| `expressions`            | DSL 기반 표현식 라우터 엔진이 내부적으로 사용됩니다. 기존 라우터 구성 인터페이스도 여전히 보이지만, 라우트 객체의 expression 필드에 수동으로 라우터 표현식을 작성하고 제공할 수도 있습니다. | ✅ 고급       | 수동 표현식 작성 가능   |
| `traditional`            | 3.0 이전 라우터 엔진이 사용됩니다. 구성 인터페이스는 3.0 이전 Kong과 동일하며, 라우트 객체의 expression 필드는 보이지 않습니다.                                                             | ⚠️ Deprecated | 3.0에서 피해야 함       |

### 라우터 구현 비교

| 측면            | traditional_compatible | expressions | traditional  |
| --------------- | ---------------------- | ----------- | ------------ |
| **성능**        | 높음                   | 높음        | 낮음         |
| **호환성**      | 완전                   | 부분적      | 완전         |
| **표현식 제어** | 자동                   | 수동 가능   | 없음         |
| **증분 재구성** | ✅ 지원                | ✅ 지원     | ❌ 미지원    |
| **권장 사용**   | ✅ 일반적              | ✅ 고급     | ❌ 피해야 함 |

### Deprecation 경고

- **traditional 모드**: Kong 3.0에서 피해야 하며, traditional_compatible이 예상대로 작동하지 않는 경우에만 사용해야 합니다
- **제거 예정**: 이 라우터 버전은 Kong의 다음 주요 릴리스에서 제거될 예정입니다

## Lua 제한 설정

### 요청 헤더 제한

| 설정                  | 설명                                       | 기본값 | 범위   |
| --------------------- | ------------------------------------------ | ------ | ------ |
| `lua_max_req_headers` | 기본적으로 파싱할 최대 요청 헤더 수입니다. | `100`  | 1-1000 |

### 응답 헤더 제한

| 설정                   | 설명                                       | 기본값 | 범위   |
| ---------------------- | ------------------------------------------ | ------ | ------ |
| `lua_max_resp_headers` | 기본적으로 파싱할 최대 응답 헤더 수입니다. | `100`  | 1-1000 |

### URI 인수 제한

| 설정               | 설명                                           | 기본값 | 범위   |
| ------------------ | ---------------------------------------------- | ------ | ------ |
| `lua_max_uri_args` | 기본적으로 파싱할 최대 요청 URI 인수 수입니다. | `100`  | 1-1000 |

### POST 인수 제한

| 설정                | 설명                                            | 기본값 | 범위   |
| ------------------- | ----------------------------------------------- | ------ | ------ |
| `lua_max_post_args` | 기본적으로 파싱할 최대 요청 POST 인수 수입니다. | `100`  | 1-1000 |

### Lua 제한 설정 영향

| 설정                | 낮은 값         | 높은 값 |
| ------------------- | --------------- | ------- |
| **메모리 사용량**   | 낮음            | 높음    |
| **성능**            | 높음            | 낮음    |
| **보안**            | 높음 (DoS 방지) | 낮음    |
| **플러그인 호환성** | 낮음            | 높음    |

### 프록시 동작에 미치는 영향

- **프록시 요청**: Kong이 모든 요청 헤더를 전송하므로 이 설정은 영향을 주지 않습니다
- **프록시 응답**: Kong이 모든 응답 헤더를 반환하므로 이 설정은 영향을 주지 않습니다
- **플러그인 제한**: Kong과 플러그인이 읽을 수 있는 헤더/인수 수를 제한하는 데 사용됩니다

## Vault 지연 로딩 설정 (최소 버전: 3.11)

| 설정                       | 설명                                                                                                                                          | 기본값 | 최소 버전 |
| -------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ------ | --------- |
| `vaults_lazy_load_secrets` | 활성화되면 vault 시크릿으로 저장된 플러그인 옵션이 처음 요청될 때만 로드됩니다. 많은 vault 참조를 사용할 때 시작 성능을 향상시킬 수 있습니다. | `off`  | 3.11      |

### Vault 지연 로딩 비교

| 설정           | 로딩 시점                  | 성능      | 메모리 사용량 |
| -------------- | -------------------------- | --------- | ------------- |
| `off` (기본값) | 초기화 시 모든 시크릿 로드 | 느린 시작 | 높음          |
| `on`           | 첫 요청 시 시크릿 로드     | 빠른 시작 | 낮음          |

### Vault 지연 로딩 사용 사례

| 상황                | 권장 설정 | 이유               |
| ------------------- | --------- | ------------------ |
| **많은 vault 참조** | `on`      | 시작 성능 향상     |
| **적은 vault 참조** | `off`     | 즉시 사용 가능     |
| **메모리 제약**     | `on`      | 메모리 사용량 감소 |
| **성능 우선**       | `off`     | 첫 요청 지연 없음  |

## 성능 최적화 권장사항

### 워커 설정 최적화

| 환경              | worker_consistency | worker_state_update_frequency | 이유                   |
| ----------------- | ------------------ | ----------------------------- | ---------------------- |
| **개발 환경**     | `eventual`         | `3-5`                         | 빠른 반응성            |
| **프로덕션 환경** | `eventual`         | `5-10`                        | 안정성과 성능 균형     |
| **고부하 환경**   | `eventual`         | `10-15`                       | 데이터베이스 부하 감소 |

### 라우터 설정 최적화

| 사용 사례         | router_flavor            | 이유             |
| ----------------- | ------------------------ | ---------------- |
| **일반적인 사용** | `traditional_compatible` | 호환성과 성능    |
| **고급 사용자**   | `expressions`            | 수동 최적화 가능 |
| **레거시 시스템** | `traditional`            | 호환성 (임시)    |

### Lua 제한 최적화

| 환경              | 헤더 제한 | 인수 제한 | 이유          |
| ----------------- | --------- | --------- | ------------- |
| **보안 중심**     | 50-100    | 50-100    | DoS 방지      |
| **일반적인 사용** | 100-200   | 100-200   | 균형잡힌 설정 |
| **고성능**        | 200-500   | 200-500   | 높은 처리량   |

## 보안 고려사항

### Lua 제한 보안

- **DoS 방지**: 과도한 헤더/인수로 인한 메모리 고갈 방지
- **적절한 제한**: 애플리케이션 요구사항에 맞는 제한 설정
- **모니터링**: 제한 초과 시도 모니터링

### Vault 보안

- **시크릿 관리**: vault 시크릿의 안전한 관리
- **접근 제어**: vault 시크릿에 대한 적절한 접근 제어
- **로깅**: vault 접근 로그 모니터링

## 운영 권장사항

### 모니터링

- **성능 메트릭**: 라우터 재구성 시간 모니터링
- **메모리 사용량**: Lua 제한 설정의 메모리 영향 모니터링
- **데이터베이스 부하**: worker_state_update_frequency의 영향 모니터링

### 튜닝 절차

1. **기본 설정 사용**: 먼저 기본 설정으로 시작
2. **성능 측정**: 현재 성능 기준선 설정
3. **점진적 조정**: 한 번에 하나씩 설정 조정
4. **성능 검증**: 각 변경 후 성능 검증
5. **문서화**: 최적 설정 문서화

### 문제 해결

- **느린 시작**: vaults_lazy_load_secrets 활성화 고려
- **높은 지연 시간**: worker_state_update_frequency 조정
- **메모리 부족**: Lua 제한 값 감소
- **라우터 오류**: router_flavor 변경 고려
