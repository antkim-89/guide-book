# Hybrid Mode

## 하이브리드 모드 기본 설정

| 설정   | 설명                                                                                                                                                                                              | 기본값        |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
| `role` | 하이브리드 모드를 활성화하는 설정입니다. 데이터베이스가 있는 제어 평면 역할의 Kong 노드들을 실행하고, 다른 노드들이 데이터 평면 역할로 DB-less에서 실행되도록 구성 업데이트를 전달할 수 있습니다. | `traditional` |

### role 유효한 값

- `traditional`: 하이브리드 모드를 사용하지 않습니다.
- `control_plane`: 이 노드는 제어 평면 역할로 실행됩니다. 데이터베이스를 사용할 수 있으며 데이터 평면 노드에 구성 업데이트를 전달합니다.
- `data_plane`: 이는 데이터 평면 노드입니다. DB-less로 실행되며 제어 평면 노드로부터 구성 업데이트를 받습니다.

## 클러스터 mTLS 설정

| 설정                           | 설명                                                                                                                                                             | 기본값   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| `cluster_mtls`                 | 클러스터 노드 간의 검증 방법을 설정합니다.                                                                                                                       | `shared` |
| `cluster_cert`                 | 제어 평면과 데이터 평면 노드 간의 안전한 통신을 설정할 때 사용할 클러스터 인증서입니다. `kong hybrid` 명령을 사용하여 인증서/키 쌍을 생성할 수 있습니다.         | -        |
| `cluster_cert_key`             | 제어 평면과 데이터 평면 노드 간의 안전한 통신을 설정할 때 사용할 클러스터 인증서 키입니다.                                                                       | -        |
| `cluster_ca_cert`              | 다음 용도로 사용되는 PEM 형식의 신뢰할 수 있는 CA 인증서 파일입니다: 제어 평면이 데이터 평면의 인증서를 검증하고, 데이터 평면이 제어 평면의 인증서를 검증합니다. | -        |
| `cluster_allowed_common_names` | 제어 평면에 연결할 수 있는 허용된 Common Name 목록입니다. 여러 항목은 쉼표로 구분된 문자열로 제공할 수 있습니다.                                                 | -        |

### cluster_mtls 유효한 값

- `shared`: `cluster_cert`와 `cluster_cert_key` 설정으로 지정된 공유 인증서/키 쌍을 사용합니다. CP와 DP 노드는 mTLS 연결을 설정하기 위해 동일한 인증서를 제시해야 합니다.
- `pki`: `cluster_ca_cert`, `cluster_server_name`, `cluster_cert`를 사용하여 검증합니다. 각 DP 노드마다 다른 인증서이지만 클러스터 전체 공통 CA 인증서인 `cluster_ca_cert`에 의해 발급됩니다.
- `pki_check_cn`: pki와 유사하지만 `cluster_allowed_common_names`에 지정된 데이터 평면 인증서의 공통 이름을 추가로 확인합니다.

### 인증서 설정 방법

**cluster_cert, cluster_cert_key, cluster_ca_cert**는 다음 값 중 하나로 구성할 수 있습니다:

- 인증서의 절대 경로
- 인증서 내용
- base64로 인코딩된 인증서 내용

## 증분 동기화 설정

| 설정               | 설명                                                                                                                                                                                                        | 기본값 | 최소 버전 |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ | --------- |
| `incremental_sync` | 구성 변경의 증분 동기화를 활성화하거나 비활성화하는 설정입니다. 각 구성 업데이트 시 전체 엔티티 구성을 데이터 평면에 전송하는 대신, 증분 구성 동기화를 통해 변경된 구성만 데이터 평면에 전송할 수 있습니다. | `off`  | 3.10      |

**참고**: 하이브리드 모드에서 이 설정은 제어 평면과 데이터 평면 노드 모두에서 구성되어야 합니다.

## 하이브리드 모드 데이터 평면 설정

| 설정                            | 설명                                                                                                                                                          | 기본값 |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| `cluster_server_name`           | DP 노드에서 CP 노드로의 TLS 연결 SNI에서 사용되는 서버 이름입니다. CP 인증서에서 찾은 Common Name (CN) 또는 Subject Alternative Name (SAN)과 일치해야 합니다. | -      |
| `cluster_control_plane`         | **데이터 평면 노드에서만 사용**: 구성 업데이트를 가져올 제어 평면 노드의 주소 (host:port 형식).                                                               | -      |
| `cluster_telemetry_endpoint`    | **데이터 평면 노드에서만 사용**: 텔레메트리 업데이트를 게시할 제어 평면 노드의 텔레메트리 주소 (host:port 형식).                                              | -      |
| `cluster_telemetry_server_name` | Vitals 텔레메트리 데이터에 사용할 SNI (Server Name Indication extension).                                                                                     | -      |
| `cluster_dp_labels`             | 데이터 평면에 대한 레이블의 쉼표로 구분된 목록입니다. 레이블은 각 DP에 대한 추가 컨텍스트 정보를 제공하는 키-값 쌍입니다.                                     | -      |

### 데이터 평면 레이블 설정

- 각 레이블은 `key:value` 형식의 문자열로 구성되어야 합니다.
- 레이블은 Kong Konnect (SaaS)와 함께 하이브리드 모드 배포에서만 호환됩니다.
- 이 구성은 자체 호스팅 배포에서는 작동하지 않습니다.
- 키와 값은 AIP 표준을 따릅니다: https://kong-aip.netlify.app/aip/129/

**예시**: `deployment:mycloud,region:us-east-1`

## 하이브리드 모드 제어 평면 설정

| 설정                             | 설명                                                                                                                                                                                                | 기본값         |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| `cluster_listen`                 | 클러스터 제어 평면 서버가 데이터 평면 연결을 수신해야 하는 주소와 포트의 쉼표로 구분된 목록입니다. 제어 평면의 클러스터 통신 포트는 동일한 클러스터 내의 모든 데이터 평면에서 접근 가능해야 합니다. | `0.0.0.0:8005` |
| `cluster_telemetry_listen`       | 클러스터 제어 평면 서버가 데이터 평면 텔레메트리 연결을 수신해야 하는 주소와 포트의 쉼표로 구분된 목록입니다.                                                                                       | `0.0.0.0:8006` |
| `cluster_data_plane_purge_delay` | DP 노드가 오프라인이 된 시점부터 데이터베이스에서 해당 항목이 제거되는 시점까지 경과해야 하는 초 수입니다.                                                                                          | `1209600`      |
| `cluster_ocsp`                   | OCSP (Online Certificate Status Protocol)를 사용하여 DP 인증서의 폐기 상태를 확인할지 여부입니다.                                                                                                   | `off`          |
| `cluster_use_proxy`              | 하이브리드 모드 연결을 위한 HTTP CONNECT 프록시 지원을 켜는지 여부입니다. 이 옵션이 켜져 있으면 `proxy_server`가 하이브리드 모드 연결에 사용됩니다.                                                 | `off`          |
| `cluster_max_payload`            | 하이브리드 모드에서 CP에서 DP로 전송할 수 있는 최대 압축 페이로드 크기를 설정합니다.                                                                                                                | `16777216`     |

### cluster_ocsp 유효한 값

- `on`: OCSP 폐기 확인이 활성화되고 DP는 CP와의 연결을 설정하기 위해 확인을 통과해야 합니다.
- `off`: OCSP 폐기 확인이 비활성화됩니다.
- `optional`: OCSP 폐기 확인을 시도하지만, DP 제공 인증서 내에서 필요한 확장을 찾을 수 없거나 OCSP 응답자와의 통신이 실패한 경우 DP는 여전히 허용됩니다.

### 중요 참고사항

- **cluster_listen**과 **cluster_telemetry_listen** 설정은 `role`이 `control_plane`으로 설정되지 않은 경우 효과가 없습니다.
- 이 엔드포인트에 대한 연결은 Admin API 액세스 로그와 동일한 위치에 기록됩니다.
- **cluster_data_plane_purge_delay**의 기본값은 14일(1209600초)로 설정되어 있습니다. 즉, CP가 DP로부터 14일 동안 소식을 듣지 못하면 해당 항목이 제거됩니다.
- **cluster_max_payload**의 기본값은 16MB (16 _ 1024 _ 1024)입니다.
