# Request Debugging

## 개요

Request Debugging은 관리자가 프록시 경로 요청의 타이밍을 응답 헤더(`X-Kong-Request-Debug-Output`)와 선택적으로 오류 로그에 수집할 수 있게 하는 메커니즘입니다.

### 주요 특징

- **상세한 타이밍 정보**: Kong의 다양한 컴포넌트에서 소요된 시간을 제공합니다
- **컨텍스트 정보**: 플러그인, DNS 해결, 로드 밸런싱 등의 프로세스에서 시도된 도메인 이름과 같은 컨텍스트 정보를 제공합니다
- **응답 헤더 출력**: 클라이언트에게 타이밍 정보를 직접 제공합니다
- **오류 로그 출력**: 선택적으로 오류 로그에도 타이밍 정보를 기록합니다

## 기본 Request Debugging 설정

| 설정                  | 설명                                                                                                            | 기본값     |
| --------------------- | --------------------------------------------------------------------------------------------------------------- | ---------- |
| `request_debug`       | 활성화되면 Kong이 프록시 요청에 다음 헤더가 있는 경우 클라이언트와 오류 로그에 상세한 타이밍 정보를 제공합니다. | `on`       |
| `request_debug_token` | `X-Kong-Request-Debug-Token` 헤더에서 남용을 방지하는 데 사용되는 Request Debug Token입니다.                    | `<random>` |

## Request Debugging 헤더

### 필수 헤더

| 헤더                         | 설명                                                         | 필수 여부 |
| ---------------------------- | ------------------------------------------------------------ | --------- |
| `X-Kong-Request-Debug`       | 타이밍 정보를 수집하고 내보내기 위한 필터를 지정합니다.      | 필수      |
| `X-Kong-Request-Debug-Log`   | 타이밍 정보를 Kong 오류 로그에도 기록할지 여부를 설정합니다. | 선택      |
| `X-Kong-Request-Debug-Token` | 디버그 요청을 인증하는 토큰입니다.                           | 선택\*    |

**참고**: 루프백 주소에서 시작되는 디버그 요청은 이 헤더가 필요하지 않습니다.

### X-Kong-Request-Debug 필터

| 필터            | 설명                                             |
| --------------- | ------------------------------------------------ |
| `*`             | 모든 단계의 타이밍 정보를 수집합니다.            |
| `rewrite`       | rewrite 단계에서 타이밍 정보를 수집합니다.       |
| `access`        | access 단계에서 타이밍 정보를 수집합니다.        |
| `balancer`      | balancer 단계에서 타이밍 정보를 수집합니다.      |
| `response`      | response 단계에서 타이밍 정보를 수집합니다.      |
| `header_filter` | header_filter 단계에서 타이밍 정보를 수집합니다. |
| `body_filter`   | body_filter 단계에서 타이밍 정보를 수집합니다.   |
| `log`           | log 단계에서 타이밍 정보를 수집합니다.           |
| `upstream`      | upstream 단계에서 타이밍 정보를 수집합니다.      |

### X-Kong-Request-Debug 사용 예시

| 값                  | 설명                            |
| ------------------- | ------------------------------- |
| `*`                 | 모든 단계의 타이밍 정보 수집    |
| `rewrite,access`    | rewrite와 access 단계만 수집    |
| `balancer,upstream` | balancer와 upstream 단계만 수집 |
| `log`               | log 단계만 수집                 |

### X-Kong-Request-Debug-Log 설정

| 값      | 설명                                                     | 기본값  |
| ------- | -------------------------------------------------------- | ------- |
| `true`  | 타이밍 정보를 Kong 오류 로그에 notice 레벨로 기록합니다. | `false` |
| `false` | 오류 로그에 기록하지 않습니다.                           | `false` |

## 디버그 토큰 관리

### 토큰 생성

- **자동 생성**: `request_debug_token`이 설정되지 않으면 Kong이 시작, 재시작 또는 리로드할 때 랜덤 토큰을 생성합니다
- **수동 설정**: 토큰을 수동으로 지정하면 제공된 토큰이 사용됩니다

### 토큰 위치

| 위치               | 설명                                                                                                                                           |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| **Kong 오류 로그** | Kong이 시작, 재시작 또는 리로드할 때 오류 로그에 notice 레벨로 기록됩니다. 로그 라인에는 검색을 돕기 위해 `[request-debug]` 접두사가 있습니다. |
| **파일시스템**     | `{prefix}/.request_debug_token` 파일에 저장되며 Kong이 시작, 재시작 또는 리로드할 때 업데이트됩니다.                                           |

## Request Debugging 사용 방법

### 1. 기본 디버깅

```bash
curl -H "X-Kong-Request-Debug: *" \
     -H "X-Kong-Request-Debug-Token: your-token" \
     http://kong-proxy:8000/your-service
```

### 2. 특정 단계만 디버깅

```bash
curl -H "X-Kong-Request-Debug: balancer,upstream" \
     -H "X-Kong-Request-Debug-Token: your-token" \
     http://kong-proxy:8000/your-service
```

### 3. 오류 로그에도 기록

```bash
curl -H "X-Kong-Request-Debug: *" \
     -H "X-Kong-Request-Debug-Log: true" \
     -H "X-Kong-Request-Debug-Token: your-token" \
     http://kong-proxy:8000/your-service
```

### 4. 루프백에서 디버깅 (토큰 불필요)

```bash
curl -H "X-Kong-Request-Debug: *" \
     http://localhost:8000/your-service
```

## 응답 헤더 출력

### X-Kong-Request-Debug-Output 헤더

Request Debugging이 활성화되면 응답에 `X-Kong-Request-Debug-Output` 헤더가 포함됩니다. 이 헤더에는 다음 정보가 포함됩니다:

- **각 단계별 소요 시간**
- **플러그인 실행 시간**
- **DNS 해결 시간**
- **로드 밸런싱 시간**
- **업스트림 연결 시간**

### 출력 형식 예시

```
X-Kong-Request-Debug-Output: rewrite:0.001ms,access:0.005ms,balancer:0.002ms,upstream:0.010ms,response:0.001ms
```

## 보안 고려사항

### 토큰 보안

- **토큰 보호**: 디버그 토큰을 안전하게 관리하세요
- **토큰 로테이션**: 정기적으로 디버그 토큰을 변경하세요
- **접근 제한**: 디버그 기능에 대한 접근을 제한하세요

### 공개 노출 방지

- **프록시 뒤 배치**: Kong을 다른 프록시 뒤에 배치하면 디버그 인터페이스가 공개에 노출될 수 있습니다
- **네트워크 격리**: 디버그 기능을 내부 네트워크에서만 사용하세요
- **방화벽 설정**: 외부에서 디버그 헤더를 사용할 수 없도록 방화벽을 설정하세요

### 로그 보안

- **민감한 정보**: 디버그 로그에 민감한 정보가 포함될 수 있습니다
- **로그 보관**: 디버그 로그를 안전하게 보관하세요
- **접근 제어**: 디버그 로그에 대한 접근을 제한하세요

## 성능 고려사항

### 오버헤드

- **성능 영향**: Request Debugging은 약간의 성능 오버헤드를 발생시킵니다
- **선택적 사용**: 필요한 경우에만 디버깅을 활성화하세요
- **프로덕션 환경**: 프로덕션 환경에서는 신중하게 사용하세요

### 메모리 사용량

- **로그 크기**: 디버그 로그가 메모리 사용량을 증가시킬 수 있습니다
- **로그 로테이션**: 디버그 로그를 정기적으로 로테이션하세요
- **모니터링**: 메모리 사용량을 모니터링하세요

## 운영 권장사항

### 디버깅 전략

- **문제 해결**: 특정 문제를 해결할 때만 디버깅을 활성화하세요
- **단계별 디버깅**: 필요한 단계만 선택적으로 디버깅하세요
- **로그 분석**: 디버그 로그를 체계적으로 분석하세요

### 모니터링

- **성능 모니터링**: 디버깅 활성화 시 성능을 모니터링하세요
- **오류 추적**: 디버그 관련 오류를 추적하세요
- **사용량 모니터링**: 디버그 기능 사용량을 모니터링하세요

### 유지보수

- **토큰 관리**: 디버그 토큰을 정기적으로 갱신하세요
- **로그 정리**: 오래된 디버그 로그를 정리하세요
- **문서화**: 디버깅 절차를 문서화하세요
